DROP DATABASE lab3_booksdb;
CREATE DATABASE lab3_booksdb;
USE lab3_booksdb

CREATE TABLE customer (
	customerno INT PRIMARY KEY,
	lastname VARCHAR(255),
	firstname VARCHAR(255),
	address VARCHAR(255),
	city VARCHAR(255),
	statename VARCHAR(255),
	zip VARCHAR(5),
	referredby INT,
	FOREIGN KEY (referredby) REFERENCES customer(customerno)
);

CREATE TABLE orders (
	orderno INT PRIMARY KEY,
	customerno INT,
	orderdate DATE,
	shipdate DATE,
	shipstreet VARCHAR(255),
	shipcity VARCHAR(255),
	shipstate VARCHAR(255),
	shipzip VARCHAR(255),
	FOREIGN KEY (customerno) REFERENCES customer(customerno)
);

CREATE TABLE author (
	authorid VARCHAR(4) PRIMARY KEY,
	lname VARCHAR(255),
	fname VARCHAR(255)
);

CREATE TABLE publisher (
	pubid INT PRIMARY KEY,
	name VARCHAR(255),
	contact VARCHAR(25),
	phone VARCHAR(25)
);

CREATE TABLE book (
    isbn VARCHAR(10) PRIMARY KEY,
    title VARCHAR(30),
    pubdate DATE,
    pubid INT,
    cost DECIMAL(6,2),
    retail DECIMAL(6,2),
    category VARCHAR(12) ,
    FOREIGN KEY (pubid) REFERENCES publisher(pubid),
    CHECK ( 
        category IN ('Computer', 'Cooking', 'Family Life', 'Fitness', 'Children', 'Literature', 'Business', 'Self Help')
          )
);

CREATE TABLE bookauthor (
	isbn VARCHAR(10),
	authorid VARCHAR(4),
	PRIMARY KEY (isbn, authorid),
	FOREIGN KEY (isbn) REFERENCES book(isbn),
	FOREIGN KEY (authorid) REFERENCES author(authorid)
);

CREATE TABLE orderitem (
	orderno INT NOT NULL,
	itemno INT NOT NULL,
	isbn VARCHAR(10),
	quantity INT(3), 
	PRIMARY KEY (orderno, itemno), 
	FOREIGN KEY (orderno) REFERENCES orders(orderno),
	FOREIGN KEY (isbn) REFERENCES book(isbn)
);

INSERT INTO customer
VALUES (1001, 'MORALES', 'BONITA', 'P.O. BOX 651', 'EASTPOINT', 'FL', '32328', NULL);

INSERT INTO customer
VALUES (1002, 'THOMPSON', 'RYAN', 'P.O. BOX 9835', 'SANTA MONICA', 'CA', '90404', NULL);

INSERT INTO customer
VALUES (1003, 'SMITH', 'LEILA', 'P.O. BOX 66', 'TALLAHASSEE', 'FL', '32306', NULL);

INSERT INTO customer
VALUES (1004, 'PIERSON', 'THOMAS', '69821 SOUTH AVENUE', 'BOISE', 'ID', '83707', NULL);

INSERT INTO customer
VALUES (1005, 'GIRARD', 'CINDY', 'P.O. BOX 851', 'SEATTLE', 'WA', '98115', NULL);

INSERT INTO customer
VALUES (1006, 'CRUZ', 'MESHIA', '82 DIRT ROAD', 'ALBANY', 'NY', '12211', NULL);

INSERT INTO customer
VALUES (1007, 'GIANA', 'TAMMY', '9153 MAIN STREET', 'AUSTIN', 'TX', '78710', 1003);

INSERT INTO customer
VALUES (1008, 'JONES', 'KENNETH', 'P.O. BOX 137', 'CHEYENNE', 'WY', '82003', NULL);

INSERT INTO customer
VALUES (1009, 'PEREZ', 'JORGE', 'P.O. BOX 8564', 'BURBANK', 'CA', '91510', 1003);

INSERT INTO customer
VALUES (1010, 'LUCAS', 'JAKE', '114 EAST SAVANNAH', 'ATLANTA', 'GA', '30314', NULL);

INSERT INTO customer
VALUES (1011, 'MCGOVERN', 'REESE', 'P.O. BOX 18', 'CHICAGO', 'IL', '60606', NULL); 

INSERT INTO customer
VALUES (1012, 'MCKENZIE', 'WILLIAM', 'P.O. BOX 971', 'BOSTON', 'MA', '02110', NULL);

INSERT INTO customer
VALUES (1013, 'NGUYEN', 'NICHOLAS', '357 WHITE EAGLE AVE.', 'CLERMONT', 'FL', '34711', 1006);

INSERT INTO customer
VALUES (1014, 'LEE', 'JASMINE', 'P.O. BOX 2947', 'CODY', 'WY', '82414', NULL);

INSERT INTO customer
VALUES (1015, 'SCHELL', 'STEVE', 'P.O. BOX 677', 'MIAMI', 'FL', '33111', NULL);

INSERT INTO customer
VALUES (1016, 'DAUM', 'MICHELL', '9851231 LONG ROAD', 'BURBANK', 'CA', '91508', 1010);

INSERT INTO customer
VALUES (1017, 'NELSON', 'BECCA', 'P.O. BOX 563', 'KALMAZOO', 'MI', '49006', NULL);

INSERT INTO customer
VALUES (1018, 'MONTIASA', 'GREG', '1008 GRAND AVENUE', 'MACON', 'GA', '31206', NULL);

INSERT INTO customer
VALUES (1019, 'SMITH', 'JENNIFER', 'P.O. BOX 1151', 'MORRISTOWN', 'NJ', '07962', 1003);

INSERT INTO orders
VALUES (1000,1005,'2003-03-31','2003-04-02','1201 ORANGE AVE', 'SEATTLE', 'WA', '98114');

INSERT INTO orders
VALUES (1001,1010,'2003-03-31','2003-04-01', '114 EAST SAVANNAH', 'ATLANTA', 'GA', '30314');

INSERT INTO orders
VALUES (1002,1011,'2003-03-31','2003-04-01','58 TILA CIRCLE', 'CHICAGO', 'IL', '60605');

INSERT INTO orders
VALUES (1003,1001,'2003-04-01','2003-04-01','958 MAGNOLIA LANE', 'EASTPOINT', 'FL', '32328');

INSERT INTO orders
VALUES (1005,1018,'2003-04-01','2003-04-02', '1008 GRAND AVENUE', 'MACON', 'GA', '31206');

INSERT INTO orders
VALUES (1006,1003,'2003-04-01','2003-04-02','558A CAPITOL HWY.', 'TALLAHASSEE', 'FL', '32307');

INSERT INTO orders
VALUES (1007,1007,'2003-04-02','2003-04-04', '9153 MAIN STREET', 'AUSTIN', 'TX', '78710');

INSERT INTO orders
VALUES (1008,1004,'2003-04-02','2003-04-03', '69821 SOUTH AVENUE', 'BOISE', 'ID', '83707');

INSERT INTO orders
VALUES (1009,1005,'2003-04-03','2003-04-05','9 LIGHTENING RD.', 'SEATTLE', 'WA', '98110');

INSERT INTO orders
VALUES (1010,1019,'2003-04-03','2003-04-04','384 WRONG WAY HOME', 'MORRISTOWN', 'NJ', '07960');

INSERT INTO orders
VALUES (1011,1010,'2003-04-03','2003-04-05', '102 WEST LAFAYETTE', 'ATLANTA', 'GA', '30311');

INSERT INTO orders
VALUES (1012,1017,'2003-04-03',NULL,'1295 WINDY AVENUE', 'KALMAZOO', 'MI', '49002');

INSERT INTO orders
VALUES (1013,1014,'2003-04-03','2003-04-04','7618 MOUNTAIN RD.', 'CODY', 'WY', '82414');

INSERT INTO orders
VALUES (1014,1007,'2003-04-04','2003-04-05', '9153 MAIN STREET', 'AUSTIN', 'TX', '78710');

INSERT INTO orders
VALUES (1016,1003,'2003-04-04',NULL,'9901 SEMINOLE WAY', 'TALLAHASSEE', 'FL', '32307');

INSERT INTO orders
VALUES (1017,1015,'2003-04-04','2003-04-05','887 HOT ASPHALT ST', 'MIAMI', 'FL', '33112');

INSERT INTO orders
VALUES (1018,1001,'2003-04-05',NULL,'95812 HIGHWAY 98', 'EASTPOINT', 'FL', '32328');

INSERT INTO orders
VALUES (1019,1018,'2003-04-05',NULL, '1008 GRAND AVENUE', 'MACON', 'GA', '31206');

INSERT INTO orders
VALUES (1020,1008,'2003-04-05',NULL,'195 JAMISON LANE', 'CHEYENNE', 'WY', '82003');

INSERT INTO author
VALUES ('S100','SMITH', 'SAM');

INSERT INTO author
VALUES ('J100','JONES','JANICE');

INSERT INTO author
VALUES ('A100','AUSTIN','JAMES');

INSERT INTO author
VALUES ('M100','MARTINEZ','SHEILA');

INSERT INTO author
VALUES ('K100','KZOCHSKY','TAMARA');

INSERT INTO author
VALUES ('P100','PORTER','LISA');

INSERT INTO author
VALUES ('A105','ADAMS','JUAN');

INSERT INTO author
VALUES ('B100','BAKER','JACK'); 

INSERT INTO author
VALUES ('P105','PETERSON','TINA');

INSERT INTO author
VALUES ('W100','WHITE','WILLIAM');

INSERT INTO author
VALUES ('W105','WHITE','LISA');

INSERT INTO author
VALUES ('R100','ROBINSON','ROBERT');

INSERT INTO author
VALUES ('F100','FIELDS','OSCAR');

INSERT INTO author
VALUES ('W110','WILKINSON','ANTHONY');

INSERT INTO publisher
VALUES(1,'PRINTING IS US','TOMMIE SEYMOUR','000-714-8321');

INSERT INTO publisher
VALUES(2,'PUBLISH OUR WAY','JANE TOMLIN','010-410-0010');

INSERT INTO publisher
VALUES(3,'AMERICAN PUBLISHING','DAVID DAVIDSON','800-555-1211');

INSERT INTO publisher
VALUES(4,'READING MATERIALS INC.','RENEE SMITH','800-555-9743');

INSERT INTO publisher
VALUES(5,'REED-N-RITE','SEBASTIAN JONES','800-555-8284');

INSERT INTO book
VALUES ('1059831198','BODYBUILD IN 10 MINUTES A DAY','2011-01-21',4,18.75,30.95, 'Fitness');

INSERT INTO book
VALUES ('0401140733','REVENGE OF MICKEY','2001-12-14',1,14.20,22.00, 'Family Life');

INSERT INTO book
VALUES ('4981341710','BUILDING A CAR WITH TOOTHPICKS','2002-03-18',2,37.80,59.95, 'Children');

INSERT INTO book
VALUES ('8843172113','DATABASE IMPLEMENTATION','1999-06-04',3,31.40,55.95, 'Computer');

INSERT INTO book
VALUES ('3437212490','COOKING WITH MUSHROOMS','2000-02-28',4,12.50,19.95, 'Cooking');

INSERT INTO book
VALUES ('3957136468','HOLY GRAIL OF ORACLE','2001-12-31',3,47.25,75.95, 'Computer');

INSERT INTO book
VALUES ('1915762492','HANDCRANKED COMPUTERS','2001-01-21',3,21.80,25.00, 'Computer');

INSERT INTO book
VALUES ('9959789321','E-BUSINESS THE EASY WAY','2002-03-01',2,37.90,54.50, 'Computer');

INSERT INTO book
VALUES ('2491748320','PAINLESS CHILD-REARING','2000-07-17',5,48.00,89.95, 'Family Life');

INSERT INTO book
VALUES ('0299282519','THE WOK WAY TO COOK','2000-09-11',4,19.00,28.75, 'Cooking');

INSERT INTO book
VALUES ('8117949391','BIG BEAR AND LITTLE DOVE','2001-11-08',5,5.32,8.95, 'Children');

INSERT INTO book
VALUES ('0132149871','HOW TO GET FASTER PIZZA','2002-11-11',4,17.85,29.95, 'Self Help');

INSERT INTO book
VALUES ('9247381001','HOW TO MANAGE THE MANAGER','1999-05-09',1,15.40,31.95, 'Business');

INSERT INTO book
VALUES ('2147428890','SHORTEST POEMS','2001-05-01',5,21.85,39.95, 'Literature');

INSERT INTO bookauthor
VALUES ('1059831198','S100');

INSERT INTO bookauthor
VALUES ('1059831198','P100');

INSERT INTO bookauthor
VALUES ('0401140733','J100');

INSERT INTO bookauthor
VALUES ('4981341710','K100');

INSERT INTO bookauthor
VALUES ('8843172113','P105');

INSERT INTO bookauthor
VALUES ('8843172113','A100');

INSERT INTO bookauthor
VALUES ('8843172113','A105');

INSERT INTO bookauthor
VALUES ('3437212490','B100');

INSERT INTO bookauthor
VALUES ('3957136468','A100');

INSERT INTO bookauthor
VALUES ('1915762492','W100');

INSERT INTO bookauthor
VALUES ('1915762492','W105');

INSERT INTO bookauthor
VALUES ('9959789321','J100');

INSERT INTO bookauthor
VALUES ('2491748320','R100');

INSERT INTO bookauthor
VALUES ('2491748320','F100');

INSERT INTO bookauthor
VALUES ('2491748320','B100');

INSERT INTO bookauthor
VALUES ('0299282519','S100');

INSERT INTO bookauthor
VALUES ('8117949391','R100');

INSERT INTO bookauthor
VALUES ('0132149871','S100');

INSERT INTO bookauthor
VALUES ('9247381001','W100');

INSERT INTO bookauthor
VALUES ('2147428890','W105');

INSERT INTO orderitem
VALUES (1000,1,'3437212490',1); 

INSERT INTO orderitem
VALUES (1001,1,'9247381001',1); 

INSERT INTO orderitem
VALUES (1001,2,'2491748320',1); 

INSERT INTO orderitem
VALUES (1002,1,'8843172113',2); 

INSERT INTO orderitem
VALUES (1003,1,'8843172113',1); 

INSERT INTO orderitem
VALUES (1003,2,'1059831198',1);

INSERT INTO orderitem
VALUES (1003,3,'3437212490',1);

INSERT INTO orderitem
VALUES (1005,1,'2147428890',1);

INSERT INTO orderitem
VALUES (1006,1,'9959789321',1);

INSERT INTO orderitem
VALUES (1007,1,'3957136468',3);

INSERT INTO orderitem
VALUES (1007,2,'9959789321',1);

INSERT INTO orderitem
VALUES (1007,3,'8117949391',1);

INSERT INTO orderitem
VALUES (1007,4,'8843172113',1);

INSERT INTO orderitem
VALUES (1008,1,'3437212490',2);

INSERT INTO orderitem
VALUES (1009,1,'3437212490',1);

INSERT INTO orderitem
VALUES (1009,2,'0401140733',1);

INSERT INTO orderitem
VALUES (1010,1,'8843172113',1);

INSERT INTO orderitem
VALUES (1011,1,'2491748320',1);

INSERT INTO orderitem
VALUES (1012,1,'8117949391',1);

INSERT INTO orderitem
VALUES (1012,2,'1915762492',2);

INSERT INTO orderitem
VALUES (1012,3,'2491748320',1);

INSERT INTO orderitem
VALUES (1012,4,'0401140733',1);

INSERT INTO orderitem
VALUES (1013,1,'8843172113',1);

INSERT INTO orderitem
VALUES (1014,1,'0401140733',2);

INSERT INTO orderitem
VALUES (1014,2,'3437212490',1);

INSERT INTO orderitem
VALUES (1016,1,'2491748320',1);

INSERT INTO orderitem
VALUES (1017,1,'8117949391',2);

INSERT INTO orderitem
VALUES (1018,1,'3437212490',1);

INSERT INTO orderitem
VALUES (1018,2,'8843172113',1);

INSERT INTO orderitem
VALUES (1019,1,'0401140733',1);

INSERT INTO orderitem
VALUES (1020,1,'3437212490',1);

-- What titles did Bonita Morales buy?
WITH book_title AS (
	SELECT isbn, orderno
	FROM orderitem 
), c_orderno AS (
	SELECT orderno, customerno
	FROM orders
), c_customerno AS (
	SELECT customerno
	FROM customer
	WHERE lastname = 'MORALES'
)
SELECT DISTINCT book.isbn, title, retail
FROM book
JOIN book_title USING(isbn)
JOIN c_orderno USING(orderno)
JOIN c_customerno USING(customerno)
ORDER BY title;

-- How many items were in each order made by the customer named Tammy Giana?
WITH ordernum AS (
	SELECT orderno, customerno
	FROM orders
), customno AS (
	SELECT customerno
	FROM customer
    WHERE lastname = 'GIANA'
), quant AS (
	SELECT quantity, orderno FROM orderitem
)
SELECT ordernum.orderno, SUM(quantity) 
FROM quant
JOIN ordernum USING(orderno)
JOIN customno USING(customerno)
GROUP BY 1;

-- window function
SELECT title, category, retail, AVG(retail)
OVER (PARTITION BY category) AS 'avg retail by cat'
FROM book;

SELECT title, category, retail, AVG(retail) 
OVER (PARTITION BY category) AS avgcat
FROM book
ORDER BY avgcat;